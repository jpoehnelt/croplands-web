/* Global Croplands - 2016-07-25
* http://www.Croplands.org
* Copyright (c) 2016 Justin Poehnelt;
* Last Modified: Mon Jul 25 2016 14:20:02
*/
angular.module("leaflet-ng-core",[]),angular.module("leaflet-ng-core").directive("lfBounds",["leafletHelpers",function(a){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(b,c,d,e){var f=e.getScope(),g=a.safeApply;e.getMap().then(function(a){a.on("moveend",function(){var b=a.getBounds();g(f,function(){f.lfBounds={northEast:{lng:b.getEast(),lat:b.getNorth()},southWest:{lng:b.getWest(),lat:b.getSouth()}}})})})}}}]),angular.module("leaflet-ng-core").directive("lfCenter",["leafletHelpers",function(a){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(b,c,d,e){var f=e.getScope(),g=a.safeApply;e.getMap().then(function(a){f.$watch("lfCenter",function(b){a.setView([b.lat,b.lng],b.zoom)},!0),a.on("moveend",function(){g(b,function(){angular.extend(f.lfCenter,{lat:a.getCenter().lat,lng:a.getCenter().lng,zoom:a.getZoom(),autoDiscover:!1})})})})}}}]),angular.module("leaflet-ng-core").directive("leaflet",["$q","leafletData",function(a,b){return{restrict:"EA",replace:!0,scope:{lfDefaults:"=",lfLayers:"=",lfCenter:"=",lfMarkers:"=",lfBounds:"="},transclude:!0,template:'<div class="angular-leaflet-map"><div ng-transclude></div></div>',controller:function(b){this._leafletMap=a.defer(),this.getMap=function(){return this._leafletMap.promise},this.getScope=function(){return b}},link:function(a,c,d,e){var f=new L.Map(c[0],a.lfDefaults);b.set("map",f,d.id),e._leafletMap.resolve(f),f.whenReady(function(){console.log("map ready"),b.set("map",f,d.id)}),a.$on("$destroy",function(){f.remove(),b.destroy(d.id)})}}}]),angular.module("leaflet-ng-core").factory("leafletData",[function(){function a(a){return angular.isDefined(a)?a:"main"}function b(b,c,e){e=a(e),angular.isDefined(d[b])||(d[b]={}),d[b][e]=c}function c(b,c){return c=a(c),angular.isDefined(d[b])&&angular.isDefined(d[b][c])?d[b][c]:void 0}var d={};return{set:b,get:c,getMap:function(a){return c("map",a)},destroy:function(b){b=a(b),angular.forEach(d,function(a,c){a.hasOwnProperty(b)&&delete d[c][b]})}}}]),angular.module("leaflet-ng-core").factory("leafletHelpers",[function(){return{safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$evalAsync(b)}}}]),angular.module("leaflet-ng-layers",["leaflet-ng-core"]),angular.module("leaflet-ng-layers").directive("lfLayers",["leafletLayers","leafletData","$q",function(a,b,c){var d=a.getAll();return{restrict:"A",scope:!1,replace:!1,require:"leaflet",controller:function(a){a._leafletLayers=c.defer(),this.getLayers=function(){return a._leafletLayers.promise}},link:function(a,c,e,f){var g,h=f.getScope();h.lfLayers;f.getMap().then(function(c){function f(a,b,e){angular.forEach(b,function(b,d){angular.isDefined(a[d])||c.removeLayer(g[e][d])}),angular.forEach(a,function(f,h){var i;angular.isDefined(g[e][h])?(i=g[e][h],angular.equals(a[h].params.options,b[h].params.options)||(angular.extend(i.options,a[h].params.options),i.redraw())):(i=d[f.type].createLayer(f.params),g.overlays[h]=i),f.visible?c.addLayer(i):c.removeLayer(i)})}var i=e.id;g=b.get("layers",i),g=angular.isDefined(g)?g:{},g.baselayers=angular.isDefined(g.baselayers)?g.baselayers:{},g.overlays=angular.isDefined(g.overlays)?g.overlays:{},a._leafletLayers.resolve(g),h.$watch("lfLayers.baselayers",function(a,b){f(a,b,"baselayers")},!0),h.$watch("lfLayers.overlays",function(a,b){f(a,b,"overlays")},!0),b.set("layers",g,i)})}}}]),angular.module("leaflet-ng-layers").factory("leafletLayers",["$log",function(a){function b(b,c){d.hasOwnProperty(b)&&a.error("[leaflet-ng-core] Layer already defined."),d[b]=c}function c(a){return d[a]}var d={xyz:{createLayer:function(a){return L.tileLayer(a.url,a.options)}},wms:{createLayer:function(a){return L.tileLayer.wms(a.url,a.options)}}};return{set:b,get:c,getAll:function(){return d}}}]),angular.module("leaflet-ng-markers",["leaflet-ng-core"]),angular.module("leaflet-ng-markers").directive("lfMarkers",["leafletData","$q","$log",function(a,b,c){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",controller:function(a){a._leafletMarkers=b.defer(),this.getMarkers=function(){return a._leafletMarkers.promise}},link:function(b,c,d,e){var f,g=e.getScope();g.lfMarkers;e.getMap().then(function(c){var e=d.id;f=a.get("markers",e),f=angular.isDefined(f)?f:{},b._leafletMarkers.resolve(f),g.$watch("lfMarkers",function(a,b){angular.forEach(f,function(b,d){angular.isDefined(a[d])||(c.removeLayer(b),delete f[d])}),angular.forEach(a,function(a,b){var d,e=L.latLng([a.lat,a.lng]);angular.isDefined(f[b])?(d=f[b],d.setLatLng(e),d.options=a.options,d.update()):(d=L.marker(e,a.options).addTo(c),c.addLayer(d),f[b]=d)})},!0),a.set("markers",f,e)})}}}]),L.Google=L.Layer.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",opacity:1,continuousWorld:!1,noWrap:!1,mapOptions:{backgroundColor:"#dddddd"}},initialize:function(a,b){L.Util.setOptions(this,b),this._ready=void 0!==google.maps.Map,this._ready||L.Google.asyncWait.push(this),this._type=a||"SATELLITE"},onAdd:function(a,b){this._map=a,this._insertAtTheBottom=b,this._initContainer(),this._initMapObject(),a.on("viewreset",this._resetCallback,this),this._limitedUpdate=L.Util.throttle(this._update,150,this),a.on("move",this._update,this),a.on("zoomanim",this._handleZoomAnim,this),a._controlCorners.bottomright.style.marginBottom="20px",this._reset(),this._update()},onRemove:function(a){a._container.removeChild(this._container),a.off("viewreset",this._resetCallback,this),a.off("move",this._update,this),a.off("zoomanim",this._handleZoomAnim,this),a._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(a){this.options.opacity=a,1>a&&L.DomUtil.setOpacity(this._container,a)},setElementSize:function(a,b){a.style.width=b.x+"px",a.style.height=b.y+"px"},_initContainer:function(){var a=this._map._container,b=a.firstChild;this._container||(this._container=L.DomUtil.create("div","leaflet-google-layer"),this._container.id="_GMapContainer_"+L.Util.stamp(this),this._container.style.zIndex="auto"),a.insertBefore(this._container,b),this.setOpacity(this.options.opacity),this.setElementSize(this._container,this._map.getSize())},_initMapObject:function(){if(this._ready){this._google_center=new google.maps.LatLng(0,0);var a=new google.maps.Map(this._container,{center:this._google_center,zoom:0,tilt:0,mapTypeId:google.maps.MapTypeId[this._type],disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1,styles:this.options.mapOptions.styles,backgroundColor:this.options.mapOptions.backgroundColor}),b=this;this._reposition=google.maps.event.addListenerOnce(a,"center_changed",function(){b.onReposition()}),this._google=a,google.maps.event.addListenerOnce(a,"idle",function(){b._checkZoomLevels()}),google.maps.event.addListenerOnce(a,"tilesloaded",function(){b.fire("load")}),this.fire("MapObjectInitialized",{mapObject:a})}},_checkZoomLevels:function(){void 0!==this._map.getZoom()&&this._google.getZoom()!==Math.round(this._map.getZoom())&&this._map.setZoom(this._google.getZoom())},_resetCallback:function(a){this._reset(a.hard)},_reset:function(a){this._initContainer()},_update:function(a){if(this._google){this._resize();var b=this._map.getCenter(),c=new google.maps.LatLng(b.lat,b.lng);this._google.setCenter(c),void 0!==this._map.getZoom()&&this._google.setZoom(Math.round(this._map.getZoom())),this._checkZoomLevels()}},_resize:function(){var a=this._map.getSize();(this._container.style.width!==a.x||this._container.style.height!==a.y)&&(this.setElementSize(this._container,a),this.onReposition())},_handleZoomAnim:function(a){var b=a.center,c=new google.maps.LatLng(b.lat,b.lng);this._google.setCenter(c),this._google.setZoom(Math.round(a.zoom))},onReposition:function(){this._google&&google.maps.event.trigger(this._google,"resize")}}),L.Google.asyncWait=[],L.Google.asyncInitialize=function(){var a;for(a=0;a<L.Google.asyncWait.length;a++){var b=L.Google.asyncWait[a];b._ready=!0,b._container&&(b._initMapObject(),b._update())}L.Google.asyncWait=[]};var gfsad={};gfsad.decToHex=function(a){if(a>255)throw"Cannot convert to hex.";return(a+256).toString(16).substr(-2).toUpperCase()};var app=angular.module("app",["leaflet-ng-core","leaflet-ng-layers","leaflet-ng-markers","ngRoute","mgcrea.ngStrap","server"]);app.config(["$tooltipProvider","$routeProvider","$sceDelegateProvider","$locationProvider","server",function(a,b,c,d,e){b.when("/app/map",{templateUrl:"/static/templates/map.html",controller:"MapController",reloadOnSearch:!1}).when("/app/data",{templateUrl:"/static/templates/data.html",controller:"DataController"}).when("/app/data/search",{templateUrl:"/static/templates/data/search.html",controller:"DataSearchController",reloadOnSearch:!1}).when("/app/data/record",{templateUrl:"/static/templates/data/record.html",controller:"DataRecordController"}).when("/app/data/classify",{templateUrl:"/static/templates/data/classify.html",controller:"ClassifyController"}).when("/app/a/login",{templateUrl:"/static/templates/account/login.html",controller:"LoginController"}).when("/app/a/register",{templateUrl:"/static/templates/account/register.html",controller:"RegisterController"}).when("/app/a/forgot",{templateUrl:"/static/templates/account/forgot.html",controller:"ForgotController"}).when("/app/a/reset",{templateUrl:"/static/templates/account/reset.html",controller:"ResetController"}).when("/app/a/logout",{templateUrl:"/static/templates/account/logout.html",controller:"LogoutController"}).when("/app/a/messages",{templateUrl:"/static/templates/account/messages.html",controller:"MessagesController"}).otherwise({templateUrl:"/static/templates/404.html"}),d.html5Mode(!0),angular.extend(a.defaults,{animation:"am-fade-and-scale",trigger:"hover",placement:"bottom",container:"body"}),c.resourceUrlWhitelist(["self","http://127.0.0.1:8000/**","https://api.croplands.org/**","http:"+e.address+"/**","https:"+e.address+"/**"])}]),app.factory("DataRecord",["mappings","$http","$rootScope","$q","DataService","log","User","$location","server",function(a,b,c,d,e,f,g,h,i){var j=i.address,k={paging:{},current:{}};return k.paging.hasNext=function(){return e.records.length>k.index+1},k.paging.hasPrevious=function(){return k.index>0},k.paging.next=function(){return k.paging.hasNext()&&k.goTo(++k.index),k.index},k.paging.previous=function(){k.paging.hasPrevious()&&k.goTo(--k.index)},k.get=function(a){var c=d.defer();return b({method:"GET",url:j+"/api/records/"+String(a)}).then(function(a){c.resolve(a.data)},function(a){c.reject(a)}),c.promise},k.goTo=function(a){void 0!==a&&(k.index=a),k.current=e.records[a],h.path("/app/data/record").search({id:k.current.id})},k}]),app.factory("DataService",["mappings","$http","$rootScope","$q","$timeout","log","User","$window","$httpParamSerializer","server",function(a,b,c,d,e,f,g,h,i,j){function k(a,b){_.each(a,function(a){a.selected=b})}function l(a,b){var c,d=a.split("\n"),e=d[0].split(",");return c=_.map(d.slice(1,d.length-1),function(a){var c={};return _.each(a.split(","),function(a,d){var f=a;b&&b[e[d]]&&(f=b[e[d]](a)),c[e[d]]=f}),c})}var m=j.address,n={records:[],count:{},columns:angular.copy(a),ordering:{},paging:{page:1,page_size:200},busy:!1,bounds:!1,ndviLimits:!1,is_initialized:!1},o=d.defer();return n.getParams=function(){var a={};return _.each(n.columns,function(b,c){var d=[];_.each(b.choices,function(a){a.selected&&d.push(a.id)}),a[c]=d}),n.bounds&&(a.southWestBounds=n.bounds.southWest.lat+","+n.bounds.southWest.lng,a.northEastBounds=n.bounds.northEast.lat+","+n.bounds.northEast.lng),n.ndviLimits&&(a.ndvi_limit_upper=n.ndviLimits.upper.join(","),a.ndvi_limit_lower=n.ndviLimits.lower.join(",")),_.assign(a,n.ordering,n.paging)},n.setDefault=function(){k(n.columns.land_use_type.choices,!1),k(n.columns.crop_primary.choices,!1),k(n.columns.water.choices,!1),k(n.columns.intensity.choices,!1),k(n.columns.year.choices,!1),k(n.columns.source_type.choices,!1)},n.reset=function(){f.info("[DataService] Reset"),n.setDefault()},n.load=function(){f.info("[DataService] Load");var a=d.defer();return n.busy=!0,n.is_initialized=!0,o.resolve(),o=d.defer(),b({url:m+"/data/search",method:"GET",params:n.getParams(),timeout:o.promise}).then(function(b){n.records=l(b.data,{id:parseInt,month:parseInt,year:parseInt,lat:parseFloat,lon:parseFloat,crop_primary:parseInt,crop_secondary:parseInt,crop_tertiary:parseInt,water:parseInt,intensity:parseInt,land_use_type:parseInt});var d=b.headers();n.count.total=d["query-count-total"],n.count.filtered=d["query-count-filtered"],a.resolve(b),c.$broadcast("DataService.load",n.records),n.busy=!1},function(b){a.reject(b)}),a.promise},n.download=function(){var a,b,c=n.getParams();c.page_size=1e5,a=i(c),b=m+"/data/download?"+a,h.open(b)},n.init=function(){f.info("[DataService] Init"),n.is_initialized||(n.setDefault(),n.load(),n.is_initialized=!0)},n}]),app.factory("RatingService",["$http","$rootScope","log","User","$q","locationFactory","server",function(a,b,c,d,e,f,g){function h(b,d){var g=e.defer();return a({method:"POST",url:k+"/api/ratings",data:{record_id:b.id,rating:d}}).then(function(a){b.user_rating=a.data,b.visited=!0,f.setIcon(b),c.debug("[RatingService] Set the rating to: "+String(d)),g.resolve(b)},function(a){c.error("[RatingService] Could not set rating."),g.reject(a)}),g.promise}function i(){c.info("[RatingService] Getting Ratings for Records");var b,g=e.defer();return d.isLoggedIn()&&d.get().id?(b=d.get().id,a({method:"GET",url:k+'/api/ratings?q={"filters":[{"name":"user_id","op":"eq","val":'+b+"}]}"}).then(function(a){c.info(a),_.each(a.data.objects,function(a){j[a.record_id]=a}),_.each(f.getRecords(),function(a){j[a.id]&&(a.user_rating=j[a.id],f.setIcon(a))}),g.resolve()},function(a){c.error(a),g.reject(a)})):g.reject(),g.promise}var j={},k=g.address;return b.$on("locationFactory.markers.downloaded",function(){i()}),{rateRecord:h,getRecordRatings:i}}]),app.factory("User",["$http","$window","$q","log","$rootScope","$location","server",function(a,b,c,d,e,f,g){function h(){return u}function i(){var a;return a=u.role?u.role:"anon"}function j(c){u=JSON.parse(b.atob(c.split(".")[1])),u.token=c,b.localStorage.user=JSON.stringify(u),a.defaults.headers.common.authorization="bearer "+u.token}function k(){if(u.expires&&u.token){var a=u.expires-Math.floor((new Date).getTime()/1e3);return a>300}return!1}function l(){var a;try{a=JSON.parse(window.atob(decodeURIComponent(f.search().n))),f.path(a.path).search(a.params)}catch(c){b.location.href="/"}}function m(b,d){var e=c.defer();return a.post("https://api.croplands.org/auth/reset",{token:b,password:d}).then(function(){e.resolve(!0)},function(){e.resolve(!1)}),e.promise}function n(b,f){d.info("[User] Logging in...");var g=c.defer(),h={email:b,password:f},i={"Content-Type":"application/json"};return a.post(v+"/auth/login",h,i).then(function(a){d.info("[User] Successfully logged in."),a.data.data.token&&j(a.data.data.token),g.resolve(a.data),e.$emit("User.change")},function(a){a.data?g.reject(a.data):g.reject()}),g.promise}function o(b){var f=c.defer(),g={Accept:"application/json","Content-Type":"application/json"};return a.post(v+"/auth/register",b,g).then(function(a){d.info("[User] Successfully registered."),a.data.data.token&&j(a.data.data.token),f.resolve(a.data),e.$emit("User.change")},function(a){a.data?f.reject(a.data):f.reject(a)}),f.promise}function p(b){var e={email:b},f=c.defer(),g={Accept:"application/json","Content-Type":"application/json"};return a.post(v+"/auth/forgot",e,g).then(function(a){d.info("[User] Sending reset email."),f.resolve(a.data)},function(a){a.data?f.reject(a.data):f.reject()}),f.promise}function q(b,e){var f={password:b,token:e},g=c.defer(),h={Accept:"application/json","Content-Type":"application/json"};return a.post(v+"/auth/reset",f,h).then(function(a){d.info("[User] Changing password."),a.data.data.token&&j(a.data.data.token),g.resolve(a.data)},function(a){a.data?g.reject(a.data):g.reject()}),g.promise}function r(){d.info("[User] Removing user token."),b.localStorage.user&&b.localStorage.removeItem("user"),u={},delete a.defaults.headers.common.authorization,delete a.defaults.headers.post.authorization,delete a.defaults.headers.put.authorization,delete a.defaults.headers.patch.authorization,e.$emit("User.change")}function s(){var a=JSON.parse(b.localStorage.user);j(a.token),e.$emit("User.change")}function t(){d.info("Checking for existence of user token."),b.localStorage.user&&s(),angular.element(b).on("storage",function(){b.localStorage.user?s():u={}})}var u={},v=g.address;return t(),{changePassword:m,getRole:i,isLoggedIn:k,login:n,logout:r,register:o,forgot:p,reset:q,get:h,goNext:l}}]),app.constant("countries",["Afghanistan","Aland Islands","Albania","Algeria","American Samoa","Andorra","Angola","Anguilla","Antarctica","Antigua And Barbuda","Argentina","Armenia","Aruba","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bermuda","Bhutan","Bolivia, Plurinational State of","Bonaire, Sint Eustatius and Saba","Bosnia and Herzegovina","Botswana","Bouvet Island","Brazil","British Indian Ocean Territory","Brunei Darussalam","Bulgaria","Burkina Faso","Burundi","Cambodia","Cameroon","Canada","Cape Verde","Cayman Islands","Central African Republic","Chad","Chile","China","Christmas Island","Cocos (Keeling) Islands","Colombia","Comoros","Congo","Congo, the Democratic Republic of the","Cook Islands","Costa Rica","Cote d'Ivoire","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Ethiopia","Falkland Islands (Malvinas)","Faroe Islands","Fiji","Finland","France","French Guiana","French Polynesia","French Southern Territories","Gabon","Gambia","Georgia","Germany","Ghana","Gibraltar","Greece","Greenland","Grenada","Guadeloupe","Guam","Guatemala","Guernsey","Guinea","Guinea-Bissau","Guyana","Haiti","Heard Island and McDonald Islands","Holy See (Vatican City State)","Honduras","Hong Kong","Hungary","Iceland","India","Indonesia","Iran, Islamic Republic of","Iraq","Ireland","Isle of Man","Israel","Italy","Jamaica","Japan","Jersey","Jordan","Kazakhstan","Kenya","Kiribati","Korea, Democratic People's Republic of","Korea, Republic of","Kuwait","Kyrgyzstan","Lao People's Democratic Republic","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Macao","Macedonia, The Former Yugoslav Republic Of","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Martinique","Mauritania","Mauritius","Mayotte","Mexico","Micronesia, Federated States of","Moldova, Republic of","Monaco","Mongolia","Montenegro","Montserrat","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Caledonia","New Zealand","Nicaragua","Niger","Nigeria","Niue","Norfolk Island","Northern Mariana Islands","Norway","Oman","Pakistan","Palau","Palestinian Territory, Occupied","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Pitcairn","Poland","Portugal","Puerto Rico","Qatar","Reunion","Romania","Russian Federation","Rwanda","Saint Barthelemy","Saint Helena, Ascension and Tristan da Cunha","Saint Kitts and Nevis","Saint Lucia","Saint Martin (French Part)","Saint Pierre and Miquelon","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Sint Maarten (Dutch Part)","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Georgia and the South Sandwich Islands","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Svalbard and Jan Mayen","Swaziland","Sweden","Switzerland","Syrian Arab Republic","Taiwan, Province of China","Tajikistan","Tanzania, United Republic of","Thailand","Timor-Leste","Togo","Tokelau","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Turks and Caicos Islands","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","United States Minor Outlying Islands","Uruguay","Uzbekistan","Vanuatu","Venezuela, Bolivarian Republic of","Viet Nam","Virgin Islands, British","Virgin Islands, U.S.","Wallis and Futuna","Western Sahara","Yemen","Zambia","Zimbabwe"]),app.factory("geoHelperService",[function(){function a(a,b,c){var d,e,f,g,h=6378.1;return 10>=c||-1===b?[a.lat,a.lng]:(d=a[0]*(Math.PI/180),e=a[1]*(Math.PI/180),b*=Math.PI/180,f=Math.asin(Math.sin(d)*Math.cos(c/h)+Math.cos(d)*Math.sin(c/h)*Math.cos(b)),g=e+Math.atan2(Math.sin(b)*Math.sin(c/h)*Math.cos(d),Math.cos(c/h)-Math.sin(d)*Math.sin(f)),[f*(180/Math.PI),g*(180/Math.PI)])}return{destination:a}}]),app.service("log",["$log","$timeout",function(a,b){var c=[],d="[GFSAD] ",e=function(a){c.push({date:Date.now(),message:a})};this.info=function(f,g){a.info(d+f),g&&(e(f),b(function(){c=c.slice(1)},1e4))},this.warn=function(f,g){a.warn(d+f),g&&(e(f),b(function(){c=c.slice(1)},1e4))},this.error=function(f,g){a.error(d+f),g&&(e(f),b(function(){c=c.slice(1)},1e4))},this.debug=function(b){a.debug(d+b)},this.getLog=function(){return c}}]),app.factory("mapService",["leafletLayers",function(a){a.set("google",{createLayer:function(a){var b;return b=a.type||"SATELLITE",new L.Google(b,a.options)}});var b={center:{lat:0,lng:0,zoom:2},layers:{baselayers:{googleHybrid:{name:"Satellite",params:{type:"HYBRID"},type:"google",visible:!0},googleTerrain:{name:"Terrain",params:{type:"TERRAIN"},type:"google",visible:!1},googleRoadmap:{name:"Streets",params:{type:"ROADMAP"},type:"google",visible:!1}},overlays:{Global_1000m_L3_v20150101:{name:"Global GCE 1km Multi-study Cropland Mask Product",visible:!1,type:"xyz",params:{options:{band:"class",subdomains:"abc"},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=Global_1000m_L3_v20150101&band={band}"},legend:[{label:"Croplands, Irrigation major",color:"#FF00FF"},{label:"Croplands, Irrigation minor",color:"#00FF00"},{label:"Croplands, Rainfed",color:"#FFFF00"},{label:"Croplands, Rainfed minor fragments",color:"#00FFFF"},{label:"Croplands, Rainfed very minor fragments",color:"#D2B58C"}],attribution:'<a href="http://geography.wr.usgs.gov/science/app/docs/Global-cropland-extent-V10-teluguntla-thenkabail-xiong.pdf">Teluguntla et al., 2015</a>'},Global_1000m_L4_v20120101:{name:"Global GCE 1km Cropland Dominance and Other Products",visible:!1,type:"xyz",params:{options:{band:"class",subdomains:"abc"},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=Global_1000m_L4_v20120101&band={band}"},legend:[{label:"Irrigated: Wheat and Rice Dominant",color:"#0000FF"},{label:"Irrigated: Mixed Crops 1: Wheat, Rice, Barley, Soybeans",color:"#A020EF"},{label:"Irrigated: Mixed Crops 2: Corn, Wheat, Rice, Cotton, Orchards",color:"#FF00FF"},{label:"Rainfed: Wheat, Rice, Soybeans, Sugarcane, Corn, Cassava",color:"#00FFFF"},{label:"Rainfed: Wheat and Barley Dominant",color:"#FFFF00"},{label:"Rainfed: Corn and Soybeans Dominant",color:"#007A0B"},{label:"Rainfed: Mixed Crops 1: Wheat, Corn, Rice, Barley, Soybeans",color:"#00FF00"},{label:"Minor Fractions of Mixed Crops: Wheat, Maize, Rice, Barley, Soybeans",color:"#505012"},{label:"Other Classes",color:"#B2B2B2"}],attribution:'<a href="https://powellcenter.usgs.gov/globalcroplandwater/sites/default/files/August%20HLA-final-1q-high-res.pdf">Thenkabail et al., 2012</a>'},SouthAsia_250m_L4_v20151201:{name:"South Asia 250m Croplands 2010-2011 from ACCA",visible:!0,type:"xyz",params:{options:{band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(37.0985,60.895),L.latLng(6.006,97.416))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=SouthAsia_250m_L4_v20151201&band={band}"},legend:[{label:"Irrigated-SW/GW-DC-rice-wheat",color:"#006400"},{label:"Irrigated-SW/GW-DC-rice-rice",color:"#00ff00"},{label:"Irrgated-SW-DC-beans/cotton-wheat",color:"#a0c27c"},{label:"Irrigated-SW-DC-Sugarcane/rice-rice/Plantations",color:"#7e9e65"},{label:"Irrigated-DC-fallows/pulses-rice-fallow",color:"#c5e5a4"},{label:"Irrigated-GW-DC-rice-maize/chickpea",color:"#7fffd4"},{label:"Irrgated-TC-rice-mixedcrops-mixedcrops",color:"#40e0d0"},{label:"Irrigated-GW-DC-millet/sorghum/potato-wheat/mustartd",color:"#cfe09c"},{label:"Irrigated-SW-DC-cotton/chilli/maize-fallow/pulses",color:"#00ffff"},{label:"Rainfed-DC-rice-fallows-jute/rice/mixed crops",color:"#ffff00"},{label:"Rainfed-SC-rice-fallow/pulses",color:"#ffd700"},{label:"Rainfed-DC-millets-chickpea/Fallows",color:"#cdad00"},{label:"Rainfed-SC-cotton/pigeonpea/mixedcrops",color:"#8b6913"},{label:"Rainfed-SC-groundnut/millets/sorghum",color:"#cd853f"},{label:"Rainfed-SC-pigeonpea/mixedcrops",color:"#ee9a49"},{label:"Rainfed-SC-millet-fallows/mixedcrops-",color:"#d8a585"},{label:"Rainfed-SC-fallow-chickpea-",color:"#e6bc8a"},{label:"Rainfed-SC-millets/fallows-LS",color:"#e0cab4"},{label:"Rainfed-SC-mixedcrops/Plantations",color:"#bd5e4d"},{label:"Shrublands/trees/Rainfed-mixedcrops30%",color:"#a020f0"},{label:"Other LULC",color:"#c0c0c0"}]},UnitedStates_250m_L5_v20160101:{name:"United States GCE 250m Croplands 2008 from ACCA",visible:!0,type:"xyz",params:{options:{band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(49.4043,-124.5835),L.latLng(24.5025008881642,-66.8524020590759))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=UnitedStates_250m_L5_v20160101&band={band}"},legend:[{label:"Corn-Soybean",color:"#FFFF00"},{label:"Wheat-Barley",color:"#FF0000"},{label:"Potato",color:"#663300"},{label:"Alfalfa",color:"#00FF00"},{label:"Cotton",color:"#00FFFF"},{label:"Rice",color:"#0000FF"},{label:"Other Crops",color:"#FF6600"}]},SouthAmerica_30m_L1_v20160101:{name:"South America GCE 30m Cropland Extent Product 2014",visible:!0,type:"xyz",params:{options:{band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(12.835778465638036,-81.95811941094321),L.latLng(-56.073447989999984,-31.449983235209473))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=SouthAmerica_30m_L1_v20160101&band={band}"},legend:[{label:"Cropland",color:"#00FF00"}]},SouthEastAsia_30m_L1_v20160725:{name:"South East Asia GCE 30m Cropland Extent Product 2014",visible:!0,type:"xyz",params:{options:{band:"class",subdomains:"abc"},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=SouthEastAsia_30m_L1_v20160725&band={band}"},legend:[{label:"Cropland",color:"#00FF00"}]},Australia_30m_L1_v20160601:{name:"Australia GCE 30m Cropland Extent Product 2014",visible:!0,type:"xyz",params:{options:{band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(-9.83464522447101,110.000125),L.latLng(-45.00754522447101,158.961625))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=Australia_30m_L1_v20160601&band={band}"},legend:[{label:"Croplands",color:"#FFFF00"},{label:"Pasture",color:"#66FFFF"}]},Australia_250m_L3_v20160701:{name:"Australia GCE 250m Cropland Products 2000 to Present from ACCA",visible:!1,type:"xyz",params:{options:{year:2015,band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(-9.83464522447101,110.000125),L.latLng(-45.00754522447101,158.961625))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&id=Australia_250m_L3_v20160701&band={band}&year={year}"},legend:[{label:"Croplands, rainfed, SC (Season 1 & 2), all crops",color:"#FFFF00"},{label:"Croplands, rainfed, SC, pastures",color:"#66FFFF"},{label:"Croplands, irrigated, SC, DC (Season 1 & 2), all crops",color:"#FF66FF"},{label:"Croplands, irrigated, SC, pastures",color:"#00B0F0"},{label:"Croplands, irrigated, continuous, orchards ",color:"#00B050"},{label:"Croplands,  fallow ",color:"#FBD4B4"}],years:[2e3,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015]},GFSAD_Union_Product:{name:"GFSAD Union Product",visible:!1,type:"xyz",params:{options:{band:"cropland",year:2014,reducer:"mode",subdomains:"abc"},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&reducer={reducer}&band={band}&year={year}"},legend:[{label:"Not Cropland",color:"#000000 "},{label:"Cropland",color:"#00FF00"}],years:[2e3,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015]},Africa_30m_L1_v20160401:{name:"Africa GCE 30m Cropland Extent Product 2014",visible:!0,type:"xyz",params:{options:{band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(37.3494,-25.3695),L.latLng(-34.83026000000001,63.50536000000001))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&band={band}&id=Africa_30m_L1_v20160401"},legend:[{label:"Croplands",color:"#00FF00"}]},Africa_250m_L2_v20160601:{name:"Africa GCE 250m Cropland Products 2014 from ACCA",visible:!1,type:"xyz",params:{options:{year:2014,band:"class",subdomains:"abc",bounds:L.latLngBounds(L.latLng(37.3494,-25.3695),L.latLng(-34.83026000000001,63.50536000000001))},url:"//{s}.tiles.croplands.org/{z}/{x}/{y}/tile.png?collection=users/JustinPoehnelt/products&band={band}&id=Africa_250m_L2_v20160601&year={year}"},years:[2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014],legend:[{label:"Irrigated, SC, season 2",color:"#e41a1c"},{label:"Irrigated, SC, season 1",color:"#8dd3c7"},{label:"Irrigated, DC",color:"#377eb8"},{label:"Irrigated, Continuous",color:"#4daf4a"},{label:"Rainfed, SC, season 2",color:"#984ea3"},{label:"Rainfed, SC, season 1",color:"#bebada"},{label:"Rainfed, DC",color:"#ff7f00"},{label:"Rainfed, Continuous",color:"#ffff33"},{label:"Fallow-lands",color:"#e2e2e2"},{label:"Not Cropland",color:"#000000"}]}}}};return b.zoom=function(a,c,d){d&&(b.center.zoom=d),b.center.lat=a,b.center.lng=c},b.zoomIn=function(){this.center.zoom+=1},b.zoomOut=function(){this.center.zoom-=1},b}]),app.factory("mappings",[function(){var a={land_use_type:{label:"Land Use Type",style:"primary",choices:[{id:0,order:8,label:"Unknown",description:"Not cropland is..."},{id:1,order:1,label:"Cropland",description:"Cropland is..."},{id:2,order:4,label:"Forest",description:"Forest is ..."},{id:3,order:3,label:"Grassland",description:"Grassland is ..."},{id:4,order:2,label:"Barren",description:"Barrenland is ..."},{id:5,order:6,label:"Builtup",description:"Urban is ..."},{id:6,order:5,label:"Shrub",description:"Shrub is ..."},{id:7,order:7,label:"Water",description:"Water is ..."}]},water:{label:"Water Source",style:"danger",choices:[{id:0,label:"Unknown",description:"No irrigation specified..."},{id:1,label:"Rainfed",description:"Rainfed is ..."},{id:2,label:"Irrigated",description:"Irrigated is ..."}]},intensity:{label:"Intensify of Cropping",style:"success",choices:[{id:0,label:"Unknown",description:"Continuous is..."},{id:1,label:"Single",description:"Single is..."},{id:2,label:"Double",description:"Double is..."},{id:3,label:"Triple",description:"Triple is..."},{id:4,label:"Continuous",description:"Continuous is..."}]},crop_primary:{label:"Crop Type",choices:[{id:0,label:"Unknown",description:"No crop type specified."},{id:1,label:"Wheat",description:""},{id:2,label:"Maize (Corn)",description:""},{id:3,label:"Rice",description:""},{id:4,label:"Barley",description:""},{id:5,label:"Soybeans",description:""},{id:6,label:"Pulses",description:""},{id:7,label:"Cotton",description:""},{id:8,label:"Potatoes",description:""},{id:9,label:"Alfalfa",description:""},{id:10,label:"Sorghum",description:""},{id:11,label:"Millet",description:""},{id:12,label:"Sunflower",description:""},{id:13,label:"Rye",description:""},{id:14,label:"Rapeseed or Canola",description:""},{id:15,label:"Sugarcane",description:""},{id:16,label:"Groundnuts or Peanuts",description:""},{id:17,label:"Cassava",description:""},{id:18,label:"Sugarbeets",description:""},{id:19,label:"Palm",description:""},{id:20,
label:"Others",description:""},{id:21,label:"Plantations",description:"Plantations or other continuous crops"},{id:22,label:"Fallow",description:""},{id:23,label:"Tef",description:""},{id:24,label:"Pasture",description:"May be managed"},{id:25,label:"Oats",description:""}]},lat:{label:"Latitude"},lon:{label:"Longitude"},source_type:{label:"Source of Data",choices:[{id:"ground",label:"Ground"},{id:"unknown",label:"Unknown"},{id:"derived",label:"Derived"}]},user_validation:{label:"Validation Only",style:"success",choices:[{id:0,label:"Training",description:"Data is used for training."},{id:1,label:"Validation",description:"Data is used for validation."}]},year:{label:"Year",choices:[]}};a.crop_secondary=angular.copy(a.crop_primary),a.crop_tertiary=angular.copy(a.crop_primary);for(var b=(new Date).getFullYear(),c=2e3;b+1>c;c++)a.year.choices.push({label:c,id:c});return a}]),app.filter("mappings",["mappings",function(a){return function(b,c){b=b||0;try{return a[c].choices[b].label}catch(d){return b}}}]),app.filter("monthName",[function(){return function(a){var b=["January","February","March","April","May","June","July","August","September","October","November","December"];return b[a-1]}}]),app.filter("prepend",[function(){return function(a,b){return b+a}}]),app.filter("unsafe",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),app.controller("AccountFormController",["$location","$scope","log","$window",function(a,b,c,d){var e=a.path().split("/");"account"===e[1]&&e[1]?b.$emit("user."+e[2],!0):d.location.href="/"}]),app.controller("ClassifyController",["$scope","mapService","mappings","$http","leafletData","$document","log","$timeout","server","User",function(a,b,c,d,e,f,g,h,i,j){function k(b){var c=[{name:"source",op:"eq",val:"VHRI"}],e=[{field:"classifications_count",direction:"asc"},{field:"date_uploaded",direction:"desc"}],f={};f.q=JSON.stringify({order_by:e,filters:c}),f.page=1,f.results_per_page=100,f.random=Date.now().toString(),console.log(f),d.get(i.address+"/api/images",{params:f}).then(function(b){a.images=a.images.concat(b.data.objects)})}function l(){var b=e.getMap("map");o&&b.removeLayer(o),n&&b.removeLayer(n),p&&b.removeLayer(p);var c=[[a.image.corner_ne_lat,a.image.corner_ne_lon],[a.image.corner_sw_lat,a.image.corner_sw_lon]];p=L.imageOverlay("https://images.croplands.org/"+a.image.url,c,{opacity:a.opacity}),p.addTo(b);L.circle({lng:a.image.location.lon,lat:a.image.location.lat},{radius:45,fillOpacity:0}).addTo(b)}function m(){if(a.images.length>0){if(a.image=a.images[0],a.images=_.slice(a.images,1),a.image.url=a.image.url.replace("images/",""),a.center.lat=a.image.location.lat,a.center.lng=a.image.location.lon,a.center.zoom=17,a.counter){if(a.images[15]){var b=new Image;b.src="https://images.croplands.org/"+a.images[15].url.replace("images/","")}}else for(var c=0;15>c;c++)if(a.images[c]){var b=new Image;b.src="https://images.croplands.org/"+a.images[c].url.replace("images/","")}a.opacity=1,l()}}var n,o,p,q=new Date;angular.extend(a,{counter:0,center:{lat:0,lng:0,zoom:2},images:[],opacity:1,markers:{image:{layer:"markers",lat:0,lng:0}},layers:{baselayers:{googleHybrid:angular.copy(b.layers.baselayers.googleHybrid)},overlays:{markers:{type:"group",name:"markers",visible:!0}}},paths:{},buttons:[{id:1,label:"Pure Cropland",description:"Cropland is...",buttonClass:"pure-cropland"},{id:2,label:"Mixed Cropland",description:"Mixed is ...",buttonClass:"mixed-cropland"},{id:0,label:"Not Cropland",description:"Not cropland is...",buttonClass:"not-cropland"},{id:3,label:"Maybe Cropland",description:"Not cropland is...",buttonClass:"Maybe Cropland"},{id:-1,label:"Reject",description:"Reject is ...",buttonClass:"btn-default"}]}),a.$watch(function(){return a.images.length},function(a,b){0===b&&a>0&&m(),10===a&&k()}),a.skip=function(){m()},a.classify=function(b){var c=new Date;if(!(q&&500>c-q)){if(q=c,void 0!==b){var e={classification:b,image:angular.copy(a.image.id)};d.post("https://api.croplands.org/api/image_classifications",e).then(function(){a.counter++})}m()}},f.bind("keypress",function(b){switch(console.debug(b),b.keyCode){case 115:g.info("[ClassifyControler] Skip Image Shortcut"),m(),a.action="s";break;case 99:g.info("[ClassifyControler] Pure Cropland Shortcut"),a.classify(1),a.action=1;break;case 101:g.info("[ClassifyControler] Mixed Cropland Shortcut"),a.classify(2),a.action=2;break;case 102:g.info("[ClassifyControler] Zoom Out Shortcut"),a.center.zoom--,a.$apply();break;case 103:g.info("[ClassifyControler] Zoom Out Shortcut"),a.center.zoom++,a.$apply();break;case 100:g.info("[ClassifyControler] Not Cropland Shortcut"),a.classify(0),a.action=0;break;case 114:g.info("[ClassifyControler] Reject Shortcut"),a.classify(-1),a.action=-1;break;case 113:g.info("[ClassifyController] Maybe Cropland Shortcut"),a.classify(3),a.action=3;break;case 118:g.info("[ClassifyControler] Toggle Shortcut"),a.opacity>0?a.opacity=0:a.opacity=1,l()}h(function(){delete a.action},500)}),a.$watch(j.getRole,function(b){a.role=b}),a.showValidation=function(){return"admin"===a.role||"validation"===a.role},k(1)}]),app.controller("DataController",["$scope","$http","mapService","leafletData",function(a,b,c,d){function e(a){if(0===a.cultivated_area_hectares)return"black";if(0===a.crop_type)return"red";var b,c,d,e,f,g;return c=10*a.ratio,d=Math.max(Math.min((c-500)/5e4,1),0),e=Math.round(255*d),f=Math.round(255*(1-d)),g=0,b="#"+("00"+e.toString(16)).slice(-2)+("00"+f.toString(16)).slice(-2)+("00"+g.toString(16)).slice(-2)}var f;angular.extend(a,{sumCropType:0,center:c.center,layers:c.layers,geojson:{},sort:{column:"properties.crop_type",reverse:!0},sortColumn:function(b){console.log(b),a.sort.column===b?a.sort.reverse=!a.sort.reverse:(a.sort.column=b,a.sort.reverse=!1),console.log(a.sort)},moveToCountry:function(a){f.fitBounds(a.pad(.2))},goalFillAmount:function(){return 896*(.1+a.sumCropType/5e5)}}),_.each(a.layers.overlays,function(a){a.visible=!1}),b.get("https://s3.amazonaws.com/gfsad30/public/json/reference_data_coverage.json").then(function(b){_.each(b.data.features,function(b){a.sumCropType+=b.properties.crop_type,b.properties.cultivated_area_km2=parseInt(b.properties.cultivated_area_hectares/100,10),b.properties.ratio=b.properties.cultivated_area_km2/b.properties.crop_type,b.properties.visible=!0}),a.countries=b.data.features;var c=d.getMap();f=c,L.geoJson(b.data.features,{style:function(a){return{weight:2,opacity:.8,fillColor:e(a.properties),color:"white",dashArray:"3",fillOpacity:.6}},onEachFeature:function(a,b){a.properties.bounds=b.getBounds()}}).addTo(c)},function(a){console.log(a)}),a.$watch("center",function(){if(void 0!==f){var b=f.getBounds().pad(.5);_.each(a.countries,function(a){a.properties.visible=b.contains(a.properties.bounds)})}})}]),app.controller("DataRecordController",["$scope","mapService","leafletData","$location","DataRecord","$q","geoHelperService",function(a,b,c,d,e,f,g){function h(){var b=0,d=7.5,e=a.record,f={lat:e.location.lat,lng:e.location.lon},h={lat:e.location.original_lat,lng:e.location.original_lon};c.getMap("recordMap").then(function(a){_.forOwn(j,function(b){a.removeLayer(b)}),j={};var c=L.circle(f,125);j.locationAreaGrid=L.imageOverlay(i,c.getBounds()),j.locationMarker=L.marker(f,{zIndexOffset:1e3,draggable:!1}),void 0!==e.location.distance&&(b=e.location.distance/1e3),e.location.bearing&&(j.polygon=L.polygon([h,g.destination(h,e.location.bearing-d,b),g.destination(h,e.location.bearing+d,b)],{color:"#00FF00",stroke:!1})),_.forOwn(j,function(b){b.addTo(a)})},function(a){console.log(a)})}var i="/static/imgs/icons/grid.png",j={};angular.extend(a,{id:d.search().id,paging:{hasNext:e.paging.hasNext,hasPrevious:e.paging.hasPrevious,next:e.paging.next,previous:e.paging.previous},center:{lat:0,lng:0,zoom:2},layers:angular.copy(b.layers),markers:{},events:{map:{enable:[],logic:"emit"}}}),_.each(a.layers.overlays,function(a){a.visible=!1}),a.imageURL=function(a){return"https://images.croplands.org/"+a.replace("images/","")},e.get(a.id).then(function(b){a.record=b,a.center.lat=b.location.lat,a.center.lng=b.location.lon,a.center.zoom=17,h()},function(a){console.log(a)})}]),app.controller("DataSearchController",["$scope","$http","mapService","leafletData","$location","DataService","DataRecord","leafletData","server",function(a,b,c,d,e,f,g,d,h){function i(){f.is_initialized?(a.records=f.records,a.markers=l(a.records),a.ndvi=m(f.getParams()),a.busy=!1,a.count=f.count,a.percentage=a.count.filtered/a.count.total*100):(n(e.search()),f.load())}function j(){a.busy=!0,a.$evalAsync(f.load)}function k(a){f.bounds!==a&&(f.bounds=a,j())}function l(a){var b={};return _.each(a,function(a){b["m_"+a.id.toString()]={lat:parseFloat(a.lat),lng:parseFloat(a.lon)}}),b}function m(a){var b=h.address+"/data/image?";return _.each(a,function(a,c){"southWestBounds"!==c&&"northEastBounds"!==c&&"ndvi_limit_upper"!==c&&"ndvi_limit_lower"!==c&&a.length&&_.each(a,function(a){b+=c+"="+a.toString()+"&"})}),a.southWestBounds&&a.northEastBounds&&(b+="southWestBounds="+a.southWestBounds+"&",b+="northEastBounds="+a.northEastBounds+"&"),a.ndvi_limit_upper&&a.ndvi_limit_lower&&(b+="ndvi_limit_upper="+a.ndvi_limit_upper+"&",b+="ndvi_limit_lower="+a.ndvi_limit_lower+"&"),b}function n(a){console.log(a),_.each(a,function(a,b){if(f.columns[b]&&"year"!==b&&"source_type"!==b)Array.isArray(a)?_.each(a,function(a){f.columns[b].choices[parseInt(a,10)].selected=!0}):f.columns[b].choices[parseInt(a,10)].selected=!0;else if("source_type"===b){var c={};_.each(f.columns.source_type.choices,function(a,b){c[a.id]=b}),Array.isArray(a)?_.each(a,function(a){f.columns.source_type.choices[c[a]].selected=!0}):f.columns.source_type.choices[c[a]].selected=!0}else if("year"===b)Array.isArray(a)?_.each(a,function(a){f.columns.year.choices[parseInt(a,10)-2e3].selected=!0}):f.columns.year.choices[parseInt(a,10)-2e3].selected=!0;else if("southWestBounds"===b){var d=a.split(",");f.bounds={southWest:{},northEast:{}},f.bounds.southWest.lat=d[0],f.bounds.southWest.lng=d[1]}else if("northEastBounds"===b){var e=a.split(",");f.bounds.northEast.lat=e[0],f.bounds.northEast.lng=e[1]}else"page"===b?f.paging.page=parseInt(a,10):"page_size"===b?f.paging.page_size=parseInt(a,10):"ndvi_limit_upper"===b?(f.ndviLimits||(f.ndviLimits={}),f.ndviLimits.upper=a.split(",")):"ndvi_limit_lower"===b&&(f.ndviLimits||(f.ndviLimits={}),f.ndviLimits.lower=a.split(","))}),console.log(f.ndviLimits)}angular.extend(a,{tableColumns:[{id:"id",label:"ID",visible:!1},{id:"lon",label:"Longitude",visible:!1},{id:"lat",label:"Latitude",visible:!1},{id:"land_use_type",label:"Land Use",visible:!0},{id:"crop_primary",label:"Primary Crop",visible:!0},{id:"crop_secondary",label:"Secondary Crop",visible:!1},{id:"crop_tertiary",label:"Tertiary Crop",visible:!1},{id:"water",label:"Irrigation",visible:!0},{id:"intensity",label:"Intensity",visible:!0},{id:"year",label:"Year",visible:!0},{id:"month",label:"Month",visible:!1},{id:"country",label:"Country",visible:!0},{id:"source_type",label:"Source Type",visible:!0},{id:"source_class",label:"Source Class",visible:!1},{id:"source_description",label:"Source Description",visible:!1},{id:"use_validation",label:"Validation",visible:!1}],ordering:f.ordering,busy:!0,bounds:{southWest:{lat:-90,lng:-180},northEast:{lat:90,lng:180}},center:{lat:0,lng:0,zoom:2},searchInMap:!1,layers:angular.copy(c.layers),markers:{},events:{map:{enable:[],logic:"emit"}}}),_.each(a.layers.overlays,function(a){a.visible=!1}),a.sortColumn=function(a){a===f.ordering.order_by?"asc"===f.ordering.order_by_direction?f.ordering.order_by_direction="desc":f.ordering.order_by_direction="asc":(f.ordering.order_by_direction="asc",f.ordering.order_by=a),j()},a.selectColumns=function(){console.log("select columns")},a.download=f.download,a.goToRecord=g.goTo,a.reset=function(){f.reset(),j()},a.apply=j,a.zoomExtent=function(){a.center.lat=0,a.center.lng=0,a.center.zoom=2},a.$on("DataService.load",function(){a.records=f.records,console.log(f.getParams()),e.search(f.getParams()),a.markers=l(a.records),a.$evalAsync(function(){a.busy=!1}),a.ndvi=m(f.getParams()),a.count=f.count,a.percentage=a.count.filtered/a.count.total*100}),a.$watch("bounds",_.debounce(function(){a.searchInMap&&k(a.bounds)},800)),a.$watch("searchInMap",function(b,c){b!==c&&k(b?a.bounds:!1)}),i()}]),app.controller("MapController",["$scope","mapService","DataService","leafletData","$timeout","$window","$location","mappings","log",function(a,b,c,d,e,f,g,h,i){function j(a){L.DomEvent.stopPropagation(a)}function k(){var c={tableOfContentsVisible:!0,showHelp:!1,showDownloadModal:!1,busy:!1,busyDialogVisible:!1,table:{visible:!1},center:b.center,layers:b.layers},d=g.getCenter();d&&d.lat&&(b.center.lat=d.lat),d&&d.lng&&(b.center.lng=d.lng),d&&d.zoom&&(b.center.zoom=d.zoom),angular.extend(a,c),console.log(a)}g.moveCenter=function(a,b,c){this.search(_.merge(this.search(),{lat:Math.round(a*Math.pow(10,5))/Math.pow(10,5),lng:b,zoom:c}))},g.setId=function(a){this.search(_.merge(this.search(),{id:a}))},g.removeId=function(){this.search(_.omit(this.search(),"id"))},g.getId=function(){return parseInt(_.pluck(this.search(),"id"),10)},g.getCenter=function(){var a=this.search();return a.lat&&a.lng&&a.zoom?{lat:parseFloat(a.lat),lng:parseFloat(a.lng),zoom:parseInt(a.zoom,10)}:void 0},a.$watch(function(){return b.center},function(b){a.center=b},!0),a.$watch("busy",function(){a.busy&&(a.busyDialogVisible=!0)}),a.toggleLayerInfo=function(a,b){b.preventDefault(),j(b),a.infoVisible=!a.infoVisible},a.zoomExtent=function(){b.center.lat=0,b.center.lng=0,b.center.zoom=2},a.print=function(){window.print()},k()}]),app.controller("NavbarController",["$scope","User","$location",function(a,b,c){a.goToLogin=function(){var a=encodeURIComponent(window.btoa(JSON.stringify({path:c.path(),params:c.search()})));c.path("/app/a/login").search({n:a})},a.isLoggedIn=function(){return b.isLoggedIn()},a.goToLogout=function(){var a=encodeURIComponent(window.btoa(JSON.stringify({path:c.path(),params:c.search()})));c.path("/app/a/logout").search({n:a})}}]),app.controller("ConfirmController",["$scope","log",function(a,b){}]),app.controller("ForgotController",["$scope","User",function(a,b){function c(b,c){a.success=c,a.message=b}a.forgot=function(){a.busy=!0,b.forgot(a.email).then(function(b){c(b.description,!0),a.busy=!1,a.email=""},function(b){b.description?c(b.description,!1):c("Something went wrong",!1),a.busy=!1})}}]),app.controller("LoginController",["$scope","log","User","$timeout","$location",function(a,b,c,d,e){function f(b,c){a.success=c,a.message=b}a.login=function(b){return a.message=null,a.busy=!0,b?void c.login(a.email,a.password).then(function(){f("You have successfully logged in.",!0),a.busy=!1,a.email="",a.password="",c.goNext()},function(b){b.description?f(b.description,!1):f("Something went wrong",!1),a.busy=!1}):void f("Invalid Data",!1)}}]),app.controller("LogoutController",["$scope","User","$location",function(a,b,c){b.logout(),b.goNext()}]),app.controller("MessagesController",["$scope","$window","User",function(a,b,c){a.active=0,a.$watch(function(){return c.getMessages()},function(b){a.messages=b},!0),a.view=function(a){a.closed=!a.closed,a.unread=!1}}]),app.controller("RegisterController",["User","countries","$scope","$location","log",function(a,b,c,d,e){function f(a,b){c.success=b,c.message=a}if(a.isLoggedIn()){var g=encodeURIComponent(window.btoa(JSON.stringify({path:d.path(),params:d.search()})));d.path("/app/a/logout").search({n:g})}angular.extend(c,{countries:b,success:null,message:null}),c.countries=b,c.register=function(){c.busy=!0,a.register(c.registration).then(function(b){c.busy=!1,f(b.description,!0),a.goNext()},function(a){a?f(a.description,!1):f("Something went wrong",!1),c.busy=!1})}}]),app.controller("ResetController",["$location","$scope","$window","User",function(a,b,c,d){function e(a,c){b.success=c,b.message=a}b.token=a.search().token,b.reset=function(){b.busy=!0,d.reset(b.password,b.token).then(function(a){e(a.description,!0),b.busy=!1,b.close()},function(a){a.description?e(a.description,!1):e("Something went wrong",!1),b.busy=!1})},b.close=function(){c.location.href="/"}}]),app.directive("filter",["log","$q","$timeout","mappings","DataService",function(a,b,c,d,e){return{restrict:"EA",scope:{},link:function(a){angular.extend(a,{land_use_type:e.columns.land_use_type.choices,crop_primary:e.columns.crop_primary.choices,water:e.columns.water.choices,intensity:e.columns.intensity.choices,year:e.columns.year.choices,source_type:e.columns.source_type.choices,count:e.count}),a.reset=e.reset,a.apply=function(){a.$parent.busy=!0,a.$evalAsync(e.load)},a.allOptionsAreSelected=function(b){if(void 0===b)return!1;for(var c=0;c<a[b].length;c++)if(!a[b][c].selected)return!1;return!0},a.toggleAllOptions=function(b){var c=!0;a.allOptionsAreSelected(b)&&(c=!1);for(var d=0;d<a[b].length;d++)a[b][d].selected=c},a.$on("DataService.load",function(b){a.count=e.count})},templateUrl:"/static/directives/filter.html"}}]),app.directive("blur",[function(){return{restrict:"A",link:function(a,b){b.on("click",function(){b.blur()})}}}]),app.directive("legend",[function(){return{restrict:"E",scope:{items:"=items"},templateUrl:"/static/directives/legend.html"}}]),app.directive("log",["log",function(a){return{link:function(b){b.list=a.getLog(),b.$watch(function(){return a.getLog()},function(a){b.list=a},!0)},templateUrl:"/static/directives/log.html"}}]),app.directive("ndvi",["$http","$log","$q",function(){return{restrict:"E",scope:{pts:"=pts"},link:function(a){a.$watch("pts",function(){a.points=_.map(a.pts,function(a,b){var c=52.17*b,d=1e3-Math.max(3,Math.min(a,1e3));return c.toString()+","+d.toString()}).join(" ")})},templateUrl:"/static/directives/ndvi.html"}}]),app.directive("passwordConfirm",["$window",function(a){var b=[];return{scope:{valid:"=valid",minEntropy:"=minEntropy",password:"=password"},link:function(c){void 0===c.minEntropy&&(c.minEntropy=15),c.entropy=0,c.passwordsMatch=function(){return c.password===c.confirm},c.passwordIsStrong=function(){return c.entropy>c.minEntropy},c.$watch("password",function(d){return void 0===a.zxcvbn?void(c.entropy=0):void(d&&d.length>=8?c.entropy=zxcvbn(d,b).entropy:c.entropy=0)}),c.$watch(function(){return c.passwordIsStrong()&&c.passwordsMatch()},function(a){c.valid=a})},templateUrl:"/static/directives/password-confirm.html"}}]),app.directive("pieChart",["$http","$log","$q",function(){return{restrict:"E",scope:{value:"=value"},link:function(a){var b=100;a.radius=b/2,a.background="#cccccc",a.$watch("value",function(b){if(b=parseFloat(b),a.invalid=isNaN(b),a.invalid)return void(a.d="");if(b=Math.min(Math.max(b,0),100),100===b)return a.background="#237c28",void(a.d="");var c=Math.cos(2*Math.PI/(100/b)),d=Math.sin(2*Math.PI/(100/b)),e=50>=b?0:1;a.d="M"+a.radius+","+a.radius+" L"+a.radius+", 0, A"+a.radius+","+a.radius+" 0 "+e+",1 "+(a.radius+d*a.radius)+","+(a.radius-c*a.radius)+" z"})},templateUrl:"/static/directives/pieChart.html"}}]),app.directive("tableOfContents",["mapService","leafletData",function(a,b){return{templateUrl:"/static/directives/table-of-contents.html",scope:{expandBackgroundLayers:"@",expandProductLayers:"@",expandOtherLayers:"@"},link:function(b){b.layers=void 0===b.layers?a.layers:b.layers,b.changeBaseLayer=function(a){_.each(b.layers.baselayers,function(b,c){b.visible=a===c})}}}}]),app.directive("tableOfContentsLayer",[function(){return{templateUrl:"/static/directives/table-of-contents-layer.html",scope:{layer:"=",showMore:"@"},link:function(a){function b(){a.isMultiYear&&(d.options.year=c.years[c.years.length-1])}var c=a.layer,d=a.layer.params;a.isMultiYear=a.layer.years&&a.layer.years.length,a.toggleShowMore=function(){a.canShowMore()&&(a.showMore=!a.showMore)},a.canShowMore=function(){return!0},b()}}}]),app.directive("temporalBounds",["DataService",function(a){var b={upper:[],lower:[],max:0,min:1e3,init:!1},c=12;return{scope:{},link:function(d,e,f){function g(){if(!b.init){if(a.ndviLimits)for(var e=0;r>e;e++)b.upper.push({x:e*s+d.padding,y:1e3-a.ndviLimits.upper[e]+d.padding,r:c}),b.lower.push({x:e*s+d.padding,y:1e3-a.ndviLimits.lower[e]+d.padding,r:c});else for(var e=0;r>e;e++)b.upper.push({x:e*s+d.padding,y:b.max+d.padding,r:c}),b.lower.push({x:e*s+d.padding,y:b.min+d.padding,r:c});b.init=!0}d.bounds=b}function h(){_.each(d.bounds.upper,function(a){(!a.adjusted||a.y<b.max+d.padding)&&(a.y=b.max+d.padding,a.adjusted=!1)}),_.each(d.bounds.lower,function(a){(!a.adjusted||a.y>b.min+d.padding)&&(a.y=b.min+d.padding,a.adjusted=!1)})}function i(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault(),null!==n?(d.bounds[o][n].y=Math.min(Math.max((a.clientY-p)/q,b.max+d.padding),b.min+d.padding),d.bounds[o][n].adjusted=!0,d.$apply()):("max"===o&&(d.bounds.max=Math.min(Math.max((a.clientY-p)/q,0),1e3)),"min"===o&&(d.bounds.min=Math.max(Math.min((a.clientY-p)/q,1e3),0)),h(),d.$apply())}function j(b){("max"===o||"min"===o)&&h(),a.ndviLimits={upper:_.map(d.bounds.upper,function(a){return Math.round(1e3-a.y)+d.padding}),lower:_.map(d.bounds.lower,function(a){return Math.round(1e3-a.y)+d.padding})},d.$apply(),n=null,o=null,l()}function k(){angular.element(m).on("mousemove",i),angular.element(m).on("mouseup",j)}function l(){angular.element(m).off("mousemove",i),angular.element(m).off("mouseup",j)}var m,n,o,p,q,r=parseInt(f.intervals,10),s=parseFloat(f.intervalWidth);d.padding=20,m=e[0].viewportElement,q=m.clientWidth/m.viewBox.baseVal.width,d.mouseDown=function(a,b,c){a.stopPropagation&&a.stopPropagation(),n=b,o=c,p=m.getBoundingClientRect().top,k()},d.mouseOver=function(a,b,e){d.bounds[e][b].r=2*c},d.mouseOut=function(a,b,e){d.bounds[e][b].r=c},d.selectionPoints=function(){var a=_.map(d.bounds.upper,function(a){return a.x.toString()+","+a.y.toString()}),b=_.map(d.bounds.lower,function(a){return a.x.toString()+","+a.y.toString()});return _.concat(a,b.reverse()).join(" ")},g()},templateUrl:"/static/directives/temporal-bounds.html"}}]),app.directive("draggableBounds",["$document",function(a){return{restrict:"EA",scope:{x:"=x",y:"=y"},link:function(a,b,c){angular.extend(a,{radius:20});var d=b[0].children[0];d.attr("cx",a.x),d.attr("cy",a.y),d.removeAttr("ng-attr-cx"),d.removeAttr("ng-attr-cy");angular.copy(a.y)},template:'<circle ng-mousedown="mouseDown($event)" ng-attr-cx="{{ x }}" ng-attr-cy="{{ y }}" ng-attr-r="{{ radius }}" fill="red" />'}}]);